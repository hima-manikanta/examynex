<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Live Exam Monitoring - Admin Panel">
    <title>Live Monitoring - ExamyNex Admin</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">

    <style>
        .monitor-container {
            min-height: 100vh;
            background: var(--bg-gradient);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
        }

        .monitor-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-info h1 {
            font-size: var(--font-size-xl);
            margin-bottom: 0.25rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: rgba(67, 233, 123, 0.2);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid rgba(67, 233, 123, 0.4);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #43e97b;
            animation: pulse 2s ease-in-out infinite;
        }

        .monitor-content {
            padding: var(--spacing-lg);
            max-width: 1600px;
            margin: 0 auto;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .stat-box {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            text-align: center;
            animation: cardSlideIn 0.6s ease-out;
        }

        .stat-box h3 {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-box .value {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: var(--spacing-lg);
        }

        .session-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            animation: cardSlideIn 0.6s ease-out;
            transition: all var(--transition-base);
        }

        .session-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-glow);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .session-user {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .user-avatar-sm {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: var(--font-size-sm);
        }

        .session-status {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(67, 233, 123, 0.2);
            border: 1px solid rgba(67, 233, 123, 0.4);
            color: #43e97b;
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.4);
            color: #ffc107;
        }

        .status-violation {
            background: rgba(245, 87, 108, 0.2);
            border: 1px solid rgba(245, 87, 108, 0.4);
            color: #f5576c;
        }

        .session-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-sm);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            color: var(--text-secondary);
            font-size: var(--font-size-xs);
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-weight: 600;
        }

        .violations-list {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .violation-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: 0.5rem;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .violation-icon {
            color: #f5576c;
        }

        .session-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: var(--font-size-sm);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
            flex: 1;
        }

        .btn-sm:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: rgba(245, 87, 108, 0.2);
            border-color: rgba(245, 87, 108, 0.4);
        }

        .btn-danger:hover {
            background: rgba(245, 87, 108, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
        }
    </style>
</head>

<body>
    <div class="monitor-container">
        <!-- Header -->
        <header class="monitor-header">
            <div class="header-info">
                <h1>Live Exam Monitoring</h1>
                <p style="color: var(--text-secondary); font-size: var(--font-size-sm);">Real-time proctoring oversight
                </p>
            </div>
            <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="connectionStatus">Connected</span>
                </div>
                <button class="btn-secondary" onclick="goToDashboard()"
                    style="width: auto; padding: 0.5rem 1.5rem;">
                    Dashboard
                </button>
                <button class="btn-secondary" onclick="handleLogout()" style="width: auto; padding: 0.5rem 1.5rem;">
                    Logout
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="monitor-content">
            <!-- Statistics Overview -->
            <div class="stats-overview">
                <div class="stat-box">
                    <h3>Active Sessions</h3>
                    <div class="value" id="activeSessions">0</div>
                </div>
                <div class="stat-box">
                    <h3>Total Violations</h3>
                    <div class="value" id="totalViolations">0</div>
                </div>
                <div class="stat-box">
                    <h3>Warnings Issued</h3>
                    <div class="value" id="warningsIssued">0</div>
                </div>
                <div class="stat-box">
                    <h3>Terminated</h3>
                    <div class="value" id="terminatedSessions">0</div>
                </div>
            </div>

            <!-- Sessions Grid -->
            <div id="sessionsContainer" class="sessions-grid">
                <!-- Sessions will be populated here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state hidden">
                <div class="empty-state-icon">ðŸ‘€</div>
                <h2>No Active Sessions</h2>
                <p style="color: var(--text-secondary); margin-top: var(--spacing-sm);">
                    Exam sessions will appear here when students start taking exams
                </p>
            </div>
        </main>
    </div>

    <script src="config.js"></script>
    <script>
        let ws = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const activeSessions = new Map();
        let exams = [];

        // Check admin authentication
        function checkAdminAuth() {
            const token = localStorage.getItem('token');
            const role = localStorage.getItem('role');

            if (!token || role !== 'admin') {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Connect to WebSocket
        function connectWebSocket() {
            try {
                const wsUrl = getWsUrl(API_CONFIG.ENDPOINTS.WS_ADMIN);
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('WebSocket connected');
                    document.getElementById('connectionStatus').textContent = 'Connected';
                    reconnectAttempts = 0;
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('WebSocket message error:', error);
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    document.getElementById('connectionStatus').textContent = 'Error';
                };

                ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    document.getElementById('connectionStatus').textContent = 'Disconnected';

                    // Attempt to reconnect
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        reconnectAttempts++;
                        setTimeout(connectWebSocket, 3000);
                    }
                };
            } catch (error) {
                console.error('WebSocket connection error:', error);
            }
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            // Currently backend does not push session payloads; keep hook for future use
            if (data.type === 'session_update') {
                updateSession(data.session);
            } else if (data.type === 'violation') {
                handleViolation(data);
            } else if (data.type === 'session_end') {
                removeSession(data.sessionId);
            }

            updateStatistics();
            renderSessions();
        }

        // Update session data
        function updateSession(sessionData) {
            activeSessions.set(sessionData.sessionId, sessionData);
        }

        // Handle violation
        function handleViolation(data) {
            const session = activeSessions.get(data.sessionId);
            if (session) {
                if (!session.violations) {
                    session.violations = [];
                }
                session.violations.push({
                    type: data.violationType,
                    time: new Date().toLocaleTimeString()
                });
                activeSessions.set(data.sessionId, session);
            }
        }

        // Remove session
        function removeSession(sessionId) {
            activeSessions.delete(sessionId);
        }

        // Update statistics
        function updateStatistics() {
            let totalViolations = 0;
            let warnings = 0;
            let terminated = 0;

            activeSessions.forEach(session => {
                if (session.violations) {
                    totalViolations += session.violations.length;
                }
                if (session.status === 'warning') warnings++;
                if (session.status === 'terminated') terminated++;
            });

            document.getElementById('activeSessions').textContent = activeSessions.size;
            document.getElementById('totalViolations').textContent = totalViolations;
            document.getElementById('warningsIssued').textContent = warnings;
            document.getElementById('terminatedSessions').textContent = terminated;
        }

        // Render sessions
        function renderSessions() {
            const container = document.getElementById('sessionsContainer');
            const emptyState = document.getElementById('emptyState');

            if (activeSessions.size === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            let html = '';
            activeSessions.forEach((session, sessionId) => {
                const statusClass = session.status === 'active' ? 'status-active' :
                    session.status === 'warning' ? 'status-warning' :
                    session.status === 'n/a' ? 'status-warning' : 'status-violation';

                html += `
                    <div class="session-card">
                        <div class="session-header">
                            <div class="session-user">
                                <div class="user-avatar-sm">${getInitials(session.userName || 'Student')}</div>
                                <div>
                                    <div style="font-weight: 600;">${session.userName || 'Student'}</div>
                                    <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">
                                        ${session.examName || 'Exam'}
                                    </div>
                                </div>
                            </div>
                            <span class="session-status ${statusClass}">${session.status || 'active'}</span>
                        </div>

                        <div class="session-details">
                            <div class="detail-item">
                                <span class="detail-label">Session ID</span>
                                <span class="detail-value">#${sessionId.substring(0, 8)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Duration</span>
                                <span class="detail-value">${session.duration || 'n/a'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Progress</span>
                                <span class="detail-value">${session.progress ?? 'n/a'}${session.progress !== undefined ? '%' : ''}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Violations</span>
                                <span class="detail-value">${session.violations?.length || 0}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Confidence</span>
                                <span class="detail-value">${session.confidenceScore ?? 'n/a'}</span>
                            </div>
                        </div>

                        ${session.violations && session.violations.length > 0 ? `
                            <div class="violations-list">
                                ${session.violations.slice(-3).map(v => `
                                    <div class="violation-item">
                                        <span class="violation-icon">âš </span>
                                        <span>${v.type} at ${v.time}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <div class="session-actions">
                            <button class="btn-sm" onclick="viewDetails('${sessionId}')">View Details</button>
                            <button class="btn-sm btn-danger" onclick="terminateSession('${sessionId}')">Terminate</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Get initials from name
        function getInitials(name) {
            if (!name) return 'S';
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        // View session details
        function viewDetails(sessionId) {
            alert(`Session: ${sessionId}\nData shown is live from /proctor/admin/report. For more detail, extend the backend to expose per-session frames and timelines.`);
        }

        // Terminate session
        function terminateSession(sessionId) {
            if (confirm('Are you sure you want to terminate this exam session? This action cannot be undone.')) {
                // Send termination request to backend
                console.log('Terminating session:', sessionId);
                removeSession(sessionId);
                updateStatistics();
                renderSessions();
            }
        }

        // Navigate to dashboard
        function goToDashboard() {
            window.location.href = 'admin-dashboard.html';
        }

        // Handle logout
        function handleLogout() {
            if (ws) {
                ws.close();
            }
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            window.location.href = 'login.html';
        }

        async function loadLiveData() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                // Fetch exams (admin only)
                const examsRes = await fetch(getApiUrl(API_CONFIG.ENDPOINTS.EXAMS), {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!examsRes.ok) {
                    console.warn('Failed to load exams for monitoring');
                    return;
                }

                exams = await examsRes.json();

                // Fetch proctor reports per exam
                const reports = await Promise.all(exams.map(async (exam) => {
                    const r = await fetch(getApiUrl(API_CONFIG.ENDPOINTS.PROCTOR_ADMIN_REPORT(exam.id)), {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!r.ok) return { exam, sessions: [] };
                    const data = await r.json();
                    return { exam, sessions: data };
                }));

                // Flatten into activeSessions map (derived ids to avoid fakes)
                activeSessions.clear();
                reports.forEach(({ exam, sessions }) => {
                    sessions.forEach((s, idx) => {
                        const sessionId = `exam-${exam.id}-user-${s.user_id}-${idx}`;
                        activeSessions.set(sessionId, {
                            sessionId,
                            userName: `User ${s.user_id}`,
                            examName: exam.title || `Exam ${exam.id}`,
                            status: 'n/a',
                            duration: 'n/a',
                            progress: 'n/a',
                            violations: (s.violations || []).map(v => ({ type: v, time: '' })),
                            confidenceScore: s.confidence_score,
                            totalViolations: s.total_violations
                        });
                    });
                });

                updateStatistics();
                renderSessions();
            } catch (error) {
                console.error('Monitor data load error:', error);
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            if (!checkAdminAuth()) return;

            connectWebSocket();
            await loadLiveData();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>

</html>
