<!DOCTYPE html>
<html>
<head>
    <title>Webcam Proctor Test</title>
</head>
<body>

<h2>Webcam Proctor Test</h2>

<!-- ðŸ”” Warning Box -->
<div id="warningBox" style="
    display:none;
    padding:15px;
    margin:10px 0;
    font-weight:bold;
    border-radius:6px;
"></div>

<!-- ðŸ“· Webcam -->
<video id="video" autoplay width="400"></video>

<br><br>

<!-- ðŸ“„ Download Report -->
<button onclick="downloadReport()">Download Proctor Report (PDF)</button>

<script>
/* ===================== BASIC SETUP ===================== */
const video = document.getElementById("video");
const TOKEN = "PASTE_YOUR_LATEST_VALID_TOKEN_HERE";

let sessionId = null;
let frameInterval = null;
let examTerminated = false;

/* ===================== WARNING UI ===================== */
function showWarning(message, color) {
    const box = document.getElementById("warningBox");
    box.style.display = "block";
    box.style.backgroundColor = color;
    box.style.color = "#000";
    box.innerText = message;
}

/* ===================== FULLSCREEN ===================== */
function requestFullscreen() {
    if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
    }
}

document.addEventListener("fullscreenchange", () => {
    if (!document.fullscreenElement && sessionId && !examTerminated) {
        sendUIViolation("EXIT_FULLSCREEN");
    }
});

/* ===================== TAB / WINDOW SWITCH ===================== */
document.addEventListener("visibilitychange", () => {
    if (document.hidden && sessionId && !examTerminated) {
        sendUIViolation("TAB_SWITCH");
    }
});

window.addEventListener("blur", () => {
    if (sessionId && !examTerminated) {
        sendUIViolation("WINDOW_BLUR");
    }
});

/* ===================== WEBCAM ===================== */
navigator.mediaDevices.getUserMedia({ video: true })
.then(stream => video.srcObject = stream)
.catch(err => {
    alert("Webcam access denied");
    console.error(err);
});

/* ===================== START SESSION ===================== */
async function startSession() {
    const res = await fetch(
        "http://127.0.0.1:8000/proctor/start?exam_id=1",
        {
            method: "POST",
            headers: { "Authorization": "Bearer " + TOKEN }
        }
    );

    const data = await res.json();
    sessionId = data.session_id;
    console.log("Proctor session started:", sessionId);

    requestFullscreen();
    startMic();

    /* ðŸ”¥ STEP-10: frame throttling (4s) */
    frameInterval = setInterval(sendFrame, 4000);
}

/* ===================== SEND WEBCAM FRAME ===================== */
async function sendFrame() {
    if (!sessionId || examTerminated) return;
    if (document.hidden) return; // ðŸ”¥ STEP-10 optimization

    if (video.videoWidth === 0 || video.videoHeight === 0) return;

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    /* ðŸ”¥ STEP-10: compressed frame */
    const blob = await new Promise(res =>
        canvas.toBlob(res, "image/jpeg", 0.5)
    );
    if (!blob) return;

    const formData = new FormData();
    formData.append("frame", blob, "frame.jpg");

    try {
        await fetch(
            `http://127.0.0.1:8000/proctor/frame?session_id=${sessionId}`,
            {
                method: "POST",
                headers: { "Authorization": "Bearer " + TOKEN },
                body: formData
            }
        );
    } catch (err) {
        console.error("Frame send failed", err);
    }
}

/* ===================== MIC TALK DETECTION ===================== */
let audioContext, analyser, audioData, lastTalkSent = 0;

async function startMic() {
    audioContext = new AudioContext();
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    const source = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 512;

    source.connect(analyser);
    audioData = new Uint8Array(analyser.frequencyBinCount);

    monitorTalking();
}

function monitorTalking() {
    if (!analyser || examTerminated) return;

    analyser.getByteFrequencyData(audioData);
    const volume =
        audioData.reduce((a, b) => a + b, 0) / audioData.length;

    if (volume > 25 && Date.now() - lastTalkSent > 5000) {
        lastTalkSent = Date.now();
        sendTalkingEvent();
    }

    requestAnimationFrame(monitorTalking);
}

async function sendTalkingEvent() {
    const res = await fetch(
        `http://127.0.0.1:8000/proctor/audio?session_id=${sessionId}`,
        {
            method: "POST",
            headers: { "Authorization": "Bearer " + TOKEN }
        }
    );

    const data = await res.json();
    showWarning("ðŸŽ™ï¸ Talking detected", "#ffe066");

    if (data.action === "FINAL_WARNING") {
        showWarning("ðŸš¨ FINAL WARNING", "#ff6b6b");
    }
    if (data.action === "TERMINATE_EXAM") terminateExam();
}

/* ===================== UI VIOLATIONS ===================== */
async function sendUIViolation(type) {
    const res = await fetch(
        `http://127.0.0.1:8000/proctor/ui?session_id=${sessionId}&violation=${type}`,
        {
            method: "POST",
            headers: { "Authorization": "Bearer " + TOKEN }
        }
    );

    const data = await res.json();

    if (data.action === "WARNING")
        showWarning("âš ï¸ Stay on exam screen", "#ffe066");
    if (data.action === "FINAL_WARNING")
        showWarning("ðŸš¨ FINAL WARNING", "#ff6b6b");
    if (data.action === "TERMINATE_EXAM")
        terminateExam();
}

/* ===================== TERMINATE ===================== */
function terminateExam() {
    examTerminated = true;
    showWarning("âŒ Exam terminated", "#ff0000");

    clearInterval(frameInterval);
    video.srcObject?.getTracks().forEach(t => t.stop());

    alert("Exam auto-submitted.");
}

/* ===================== DOWNLOAD PDF ===================== */
function downloadReport() {
    if (!sessionId) {
        alert("Session not started yet");
        return;
    }
    window.open(
        `http://127.0.0.1:8000/proctor/report/${sessionId}/pdf`,
        "_blank"
    );
}

/* ===================== START ===================== */
startSession();
</script>

</body>
</html>
